from unittest import mock

import pytest
from django.template.exceptions import TemplateDoesNotExist
from django.utils.html import strip_tags

from applications.enums import EmailTemplateType
from applications.models import EmailTemplate
from applications.services import EmailTemplateService


@pytest.mark.django_db
@mock.patch("applications.services.get_template")
def test_reinitialize_from_file_success(mock_get_template):
    # Setup
    template, _ = EmailTemplate.objects.get_or_create(
        type=EmailTemplateType.PROCESSING,
        language="fi",
        defaults={"subject": "Old Subject", "html_body": "<p>Old Body</p>"},
    )

    # Mock template object
    mock_django_template = mock.Mock()
    # Mock template.template.source for the new implementation
    mock_django_template.template.source = "Subject Line\n\n<html>Body</html>"
    mock_get_template.return_value = mock_django_template

    # Execution
    result = EmailTemplateService.reinitialize_from_file(template)

    # Verification
    assert result is True
    template.refresh_from_db()
    assert template.subject == "Subject Line"
    assert template.html_body == "<html>Body</html>"
    # Text body should be auto-generated by save()
    assert template.text_body == strip_tags(template.html_body)


@pytest.mark.django_db
@mock.patch("applications.services.get_template")
def test_reinitialize_from_file_not_found(mock_get_template):
    # Setup
    template, _ = EmailTemplate.objects.get_or_create(
        type=EmailTemplateType.PROCESSING,
        language="fi",
        defaults={"subject": "Old Subject", "html_body": "<p>Old Body</p>"},
    )

    # Mock template does not exist
    mock_get_template.side_effect = TemplateDoesNotExist("Template not found")

    # Execution
    result = EmailTemplateService.reinitialize_from_file(template)

    # Verification
    assert result is False
    template.refresh_from_db()
    # Subject should not change
    assert template.subject != "Subject Line"


@pytest.mark.django_db
@mock.patch("applications.services.EmailTemplateService.reinitialize_from_file")
def test_ensure_templates_exist(mock_reinitialize):
    # Setup
    mock_reinitialize.return_value = True
    # Clear existing templates to verify creation
    EmailTemplate.objects.all().delete()

    # Execution
    count = EmailTemplateService.ensure_templates_exist()

    # Verification
    # Total combinations = Types * Languages
    # But EmailTemplateType has 4 values, Language has 3 values (fi, sv, en)
    # Check enums.py for exact count.
    # EmailTemplateType has 4 choices.
    # APPLICATION_LANGUAGE_CHOICES has 3.
    # Total = 12.
    expected_count = 4 * 3
    assert count == expected_count
    assert EmailTemplate.objects.count() == expected_count
    assert mock_reinitialize.call_count == expected_count
