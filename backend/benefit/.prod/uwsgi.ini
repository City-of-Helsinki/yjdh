[uwsgi]
plugin = /app/.prod/escape_json_plugin.so
http-socket = :8000
chdir = /app
module = helsinkibenefit.wsgi
static-map = /static=/var/static
uid = nobody
gid = nogroup
enable-threads = true
py-call-uwsgi-fork-hooks = true
buffer-size = 32768
master = 1
processes = 2
threads = 2
thunder-lock = true
; don't log readiness and healthz endpoints
route = ^/readiness$ donotlog:
route = ^/healthz$ donotlog:
logger-req = stdio
; json_uri and json_host are json-escaped fields defined in `escape_json_plugin.so`
log-format = "remote_addr":"%(addr)", "x_forwarded_for":"%(var.HTTP_X_FORWARDED_FOR)", "request_id":"%(var.HTTP_X_REQUEST_ID)", "remote_user":"%(user)", "bytes_sent":%(size), "request_time":%(secs), "status":%(status), "host":"%(json_host)", "request_proto":"%(proto)", "path":"%(json_uri)", "request_length":%(cl), "http_referer":"%(referer)", "http_user_agent":"%(uagent)"
log-req-encoder = format {"time":"${strftime:%%Y:%%m:%%d %%H:%%M:%%S}", "source":"uwsgi-req", ${msg}}
log-req-encoder = nl

# Suppress errors about clients closing sockets, happens with nginx as the ingress when
# http pipes are closed before workers has had the time to serve content to the pipe
ignore-sigpipe = true
ignore-write-errors = true
disable-write-exception = true

plugin-dir = /usr/local/lib/uwsgi/plugins

# Sentry logging for uWSGI
if-env = ENABLE_SENTRY_UWSGI_PLUGIN
print = Enabled sentry logging for uWSGI
plugin = sentry
alarm = logsentry sentry:dsn=$(SENTRY_DSN),logger=uwsgi.sentry

# Log full queue, segfault and harakiri errors to Sentry
alarm-backlog = logsentry
alarm-segfault = logsentry
alarm-log = logsentry HARAKIRI \[core.*\]
endif =
